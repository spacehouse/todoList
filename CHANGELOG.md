# Changelog

所有重大变更会记录在此文件中。

日期格式：`YYYY-MM-DD`

## [1.0.0] - 2026-02-18

### 新增/变更 - HUD 与配置
- 在真正的单人世界中，HUD 默认列表视图强制为 **个人**，并在配置界面中锁定为个人视图且按钮不可切换。
- 单人世界中 HUD 不再显示团队视图，避免出现“单人下仍能切换团队任务”的混淆。
- HUD 标题现在会显示当前视图名称（个人 / 团队-待分配 / 团队-已分配 / 团队-分配给我），与 GUI 顶部视图选择保持一致。
- HUD 团队视图的任务筛选逻辑与 GUI 完全对齐：
  - 团队-待分配：仅显示没有 assignee 的团队任务。
  - 团队-已分配：仅显示所有已被指派给任意玩家的团队任务。
  - 团队-分配给我：仅显示 assignee 为当前玩家的团队任务。

### 新增/变更 - 团队任务与权限
- 引入统一的团队任务操作审计日志：
  - 服务器端在处理团队任务的保存、完成状态切换、领取、放弃、指派他人等操作时，会通过权限中心校验并在日志中记录 `[TEAM_OP]` 格式的统一操作记录（包含玩家、操作类型、任务ID、标题及变更详情）。
- 增强 `TEAM_REPLACE_TASKS`（保存团队任务）逻辑：
  - 按权限中心的规则对每条任务的完成状态和指派人变更做精细校验。
  - 只对允许的变更应用修改并记录日志，对被拒绝的变更不会写入，同时给玩家发送“视图已刷新，可能被其他玩家修改”的提示。
- 增强单条团队操作：
  - `TEAM_TOGGLE_TASK_ID`：在服务器端根据当前视图和 assignee 计算上下文，使用权限中心决定是否允许完成状态切换，并记录日志。
  - `TEAM_ASSIGN_TASK_ID`：支持领取、放弃、指派他人三类语义，统一由权限中心控制，操作成功后写入统一日志。

### 新增/变更 - 团队视图同步与取消逻辑
- 新增 `TEAM_REQUEST_SYNC` 数据包：
  - 客户端可以主动向服务器请求当前最新的团队任务列表。
- 团队任务 GUI 行为统一化：
  - 在团队视图中，点击 **保存**：
    - 先通过 `TEAM_REPLACE_TASKS` 将本地变更提交服务器；
    - 然后在关闭界面时自动发送 `TEAM_REQUEST_SYNC`，客户端再次从服务器拉取最终的团队任务列表，确保界面与实际存储一致。
  - 在团队视图中，点击 **取消** 或按 **Esc** 关闭界面：
    - 不提交本地修改；
    - 自动发送 `TEAM_REQUEST_SYNC`，丢弃未保存的本地更改并重新加载服务器上的最新团队任务。
  - 关闭团队视图时会清除 `hasUnsavedChanges` 和 `teamHasUnsavedChanges` 标记。

### 新增/变更 - GUI 使用体验
- 视图切换时重置选中任务：
  - 在任务 GUI 中从一个视图切换到另一个视图时，会清空当前 `selectedTask`，避免旧的选中任务在新视图中被“空输入框”的 change 事件意外修改（例如标题被清空）。
- 优先级按钮行为优化：
  - 即使未选中任何任务，只要“添加”按钮处于可用状态，优先级按钮也会启用，用于为即将新增的任务预设优先级。
  - 当选中任务并且拥有编辑权限且该任务未完成时，可以通过优先级按钮直接修改任务优先级。
- 团队指派相关按钮显示规则调整：
  - 普通玩家在团队视图中只会看到“领取任务”和“放弃任务”按钮。
  - “指派他人”按钮仅在客户端识别为管理员（OP 权限）时显示，并且仍需通过权限中心校验 `ASSIGN_OTHERS` 操作才可使用。

### 新增/变更 - HUD 与任务刷新
- 增强 HUD 任务刷新逻辑：
  - 保留定时从本地存储刷新个人任务的机制，同时在任务 GUI 手动保存后，通过 HUD 渲染器的 `forceRefreshTasks` 方法立即刷新 HUD 数据，减少延迟。

### 新增/变更 - 文档
- 更新 `README.md`：
  - Features 中补充单人模式下 HUD 默认视图锁定为个人、隐藏团队视图的说明。
  - 补充 HUD 团队视图的精确语义（待分配 / 已分配 / 分配给我）。
  - 在团队任务使用说明中写明：保存、取消、Esc 关闭后客户端都会重新从服务器同步团队任务，保证视图与服务器一致。
  - 在“权限系统”章节下单独增加“权限中心”小节，明确其基于角色、视图范围、完成状态和指派关系做判定的职责。
  - 将“操作日志”升级为单独章节，详细说明所有通过权限中心校验且生效的团队操作会以统一 `[TEAM_OP]` 格式记录到服务器日志。
- 更新 `FEATURES_TODO.md`：
  - 将多人服务器支持部分标记为“部分已实现”，并说明当前版本已提供玩家独立任务、共享团队任务、权限管理与基础同步能力。
  - 更新最后更新时间为 `2026-02-18`。
- 更新与新增其他文档：
  - 更新 `FEATURES_COMPLETED.md`，补充单人 HUD 锁定个人视图、团队视图行为、保存/取消/ESC 后强制同步、权限中心与操作日志拆分等已完成功能。
  - 新增 `FEATURES_TODO_EN.md`（待开发功能英文版）。
  - 新增 `FEATURES_COMPLETED_EN.md`（已完成功能英文版）。
  - 新增 `CHANGELOG_EN.md`（英文变更记录，与本文件内容保持语义一致）。

> 注：早期基础功能（任务增删改查、本地存储、HUD 显示、权限中心的基本结构等）在 1.0.0 初版中已存在，此处仅记录近期增量改动。未来版本的新增特性和行为变更会继续在此文件中追加。
